<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¡°ì§ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <script th:if="${kakaoApiKey != null and !#strings.isEmpty(kakaoApiKey)}"
            type="text/javascript"
            th:src="|//dapi.kakao.com/v2/maps/sdk.js?appkey=${kakaoApiKey}&libraries=services|"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .tab-navigation {
            display: flex;
            background: white;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab-btn {
            flex: 1;
            padding: 1rem;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
            position: relative;
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
        }

        .tab-btn:hover {
            background: #e9ecef;
        }

        .tab-btn.active:hover {
            background: white;
        }

        .tab-content {
            background: white;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 2rem;
            min-height: 600px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* í¼ ìŠ¤íƒ€ì¼ */
        .form-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .form-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #495057;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: end;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.25);
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* ì§€ë„ ìŠ¤íƒ€ì¼ */
        #map {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* ëª©ë¡ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .list-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }

        .list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .list-item-title {
            font-weight: 600;
            color: #495057;
        }

        .list-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .message {
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* ë¡œë”© ìŠ¤íƒ€ì¼ */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        /* ì •ë¥˜ì¥ ìˆœì„œ ê´€ë¦¬ */
        .station-order {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .station-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            margin: 0.5rem 0;
            background: white;
            border-radius: 5px;
            cursor: move;
        }

        .station-item:hover {
            background: #e9ecef;
        }

        .station-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }
    </style>
</head>
<body>
<header class="header">
    <h1>ì¡°ì§ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
    <div class="user-info">
        <span th:text="|${user.name}ë‹˜ (${user.organizationId})|">ê´€ë¦¬ìë‹˜</span>
        <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</header>

<div class="container">
    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="tab-navigation">
        <button class="tab-btn active" onclick="showTab('stations')">1. ì •ë¥˜ì¥ ê´€ë¦¬</button>
        <button class="tab-btn" onclick="showTab('routes')">2. ë…¸ì„  ê´€ë¦¬</button>
        <button class="tab-btn" onclick="showTab('buses')">3. ë²„ìŠ¤ ê´€ë¦¬</button>
        <button class="tab-btn" onclick="showTab('overview')">í˜„í™© ë³´ê¸°</button>
    </div>

    <div class="tab-content">
        <!-- ì •ë¥˜ì¥ ê´€ë¦¬ íƒ­ -->
        <div id="stations" class="tab-pane active">
            <div class="form-section">
                <h3 class="form-title">ìƒˆ ì •ë¥˜ì¥ ì¶”ê°€</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="station-name">ì •ë¥˜ì¥ ì´ë¦„</label>
                        <input type="text" id="station-name" placeholder="ì •ë¥˜ì¥ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <button class="btn btn-primary" id="map-select-btn" onclick="addStationFromMap()">ì§€ë„ì—ì„œ ìœ„ì¹˜ ì„ íƒ</button>
                </div>
                <div id="map"></div>
                <div class="form-row" style="margin-top: 1rem;">
                    <div class="form-group">
                        <label for="station-lat">ìœ„ë„ (Latitude)</label>
                        <input type="number" id="station-lat" step="0.000001"
                               placeholder="ì˜ˆ: 37.566535"
                               min="33" max="39"
                               oninput="validateCoordinate('lat', this.value)">
                        <small style="color: #6c757d;">í•œêµ­ ì§€ì—­: 33~39 ì‚¬ì´</small>
                    </div>
                    <div class="form-group">
                        <label for="station-lng">ê²½ë„ (Longitude)</label>
                        <input type="number" id="station-lng" step="0.000001"
                               placeholder="ì˜ˆ: 126.977969"
                               min="124" max="132"
                               oninput="validateCoordinate('lng', this.value)">
                        <small style="color: #6c757d;">í•œêµ­ ì§€ì—­: 124~132 ì‚¬ì´</small>
                    </div>
                    <div class="form-group" style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <button class="btn btn-success" onclick="createStation()">ì •ë¥˜ì¥ ìƒì„±</button>
                        <button class="btn btn-secondary" onclick="usePresetLocation()">ì£¼ìš” ë„ì‹œ ì„ íƒ</button>
                    </div>
                </div>
            </div>

            <div id="stations-message" class="message"></div>

            <h3>ê¸°ì¡´ ì •ë¥˜ì¥ ëª©ë¡</h3>
            <div id="stations-list" class="loading">ì •ë¥˜ì¥ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>

        <!-- ë…¸ì„  ê´€ë¦¬ íƒ­ -->
        <div id="routes" class="tab-pane">
            <div class="form-section">
                <h3 class="form-title">ìƒˆ ë…¸ì„  ì¶”ê°€</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="route-name">ë…¸ì„  ì´ë¦„</label>
                        <input type="text" id="route-name" placeholder="ë…¸ì„  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <button class="btn btn-primary" onclick="showStationSelector()">ì •ë¥˜ì¥ ì„ íƒ</button>
                </div>

                <div id="station-selector" style="display: none;">
                    <h4>ì •ë¥˜ì¥ ìˆœì„œ ì„¤ì •</h4>
                    <p>ì •ë¥˜ì¥ì„ ì„ íƒí•˜ê³  ìˆœì„œë¥¼ ë“œë˜ê·¸ë¡œ ì¡°ì •í•˜ì„¸ìš”.</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="available-stations">ì‚¬ìš© ê°€ëŠ¥í•œ ì •ë¥˜ì¥</label>
                            <select id="available-stations" size="8" style="height: 200px;">
                                <!-- ì •ë¥˜ì¥ ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                            </select>
                        </div>
                        <div style="display: flex; flex-direction: column; justify-content: center; gap: 1rem;">
                            <button class="btn btn-secondary" onclick="addStationToRoute()">â†’ ì¶”ê°€</button>
                            <button class="btn btn-secondary" onclick="removeStationFromRoute()">â† ì œê±°</button>
                        </div>
                        <div class="form-group">
                            <label>ì„ íƒëœ ì •ë¥˜ì¥ (ìˆœì„œëŒ€ë¡œ)</label>
                            <div id="selected-stations" class="station-order">
                                <!-- ì„ íƒëœ ì •ë¥˜ì¥ë“¤ì´ í‘œì‹œë©ë‹ˆë‹¤ -->
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="createRoute()">ë…¸ì„  ìƒì„±</button>
                </div>
            </div>

            <div id="routes-message" class="message"></div>

            <h3>ê¸°ì¡´ ë…¸ì„  ëª©ë¡</h3>
            <div id="routes-list" class="loading">ë…¸ì„  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>

        <!-- ë²„ìŠ¤ ê´€ë¦¬ íƒ­ -->
        <div id="buses" class="tab-pane">
            <div class="form-section">
                <h3 class="form-title">ìƒˆ ë²„ìŠ¤ ì¶”ê°€</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="bus-real-number">ë²„ìŠ¤ ë²ˆí˜¸</label>
                        <input type="text" id="bus-real-number" placeholder="ì˜ˆ: 101ë²ˆ">
                    </div>
                    <div class="form-group">
                        <label for="bus-route">ë…¸ì„  ì„ íƒ</label>
                        <select id="bus-route">
                            <option value="">ë…¸ì„ ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            <!-- ë…¸ì„  ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bus-total-seats">ì´ ì¢Œì„ ìˆ˜</label>
                        <input type="number" id="bus-total-seats" min="1" value="30">
                    </div>
                    <button class="btn btn-success" onclick="createBus()">ë²„ìŠ¤ ìƒì„±</button>
                </div>
            </div>

            <div id="buses-message" class="message"></div>

            <h3>ê¸°ì¡´ ë²„ìŠ¤ ëª©ë¡</h3>
            <div id="buses-list" class="loading">ë²„ìŠ¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>

        <!-- í˜„í™© ë³´ê¸° íƒ­ -->
        <div id="overview" class="tab-pane">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                <div class="form-section">
                    <h3 class="form-title">ì •ë¥˜ì¥ í˜„í™©</h3>
                    <div id="overview-stations" class="loading">ë¡œë”© ì¤‘...</div>
                </div>
                <div class="form-section">
                    <h3 class="form-title">ë…¸ì„  í˜„í™©</h3>
                    <div id="overview-routes" class="loading">ë¡œë”© ì¤‘...</div>
                </div>
                <div class="form-section">
                    <h3 class="form-title">ë²„ìŠ¤ í˜„í™©</h3>
                    <div id="overview-buses" class="loading">ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ìˆ¨ê²¨ì§„ ì…ë ¥ í•„ë“œ -->
<input type="hidden" id="auth-token" th:value="${token}">

<script>
    // ì „ì—­ ë³€ìˆ˜
    let map;
    let currentMarker;
    let selectedStations = [];
    let stationsData = [];
    let routesData = [];
    let busesData = [];

    // ì¹´ì¹´ì˜¤ ì§€ë„ ë¡œë“œ í™•ì¸ ë° ì´ˆê¸°í™”
    function initializeApp() {
        console.log('ì•± ì´ˆê¸°í™” ì‹œì‘');

        // API í‚¤ í™•ì¸ (ê°œë°œìš© - ìš´ì˜ì‹œì—ëŠ” ì œê±°)
        const scripts = document.querySelectorAll('script[src*="dapi.kakao.com"]');
        if (scripts.length > 0) {
            console.log('ì¹´ì¹´ì˜¤ API ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨:', scripts[0].src);
        } else {
            console.warn('ì¹´ì¹´ì˜¤ API ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }

        // API í‚¤ê°€ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
        if (window.kakaoApiNotAvailable) {
            console.warn('ì¹´ì¹´ì˜¤ APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§€ë„ ì—†ì´ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.');
            initializeWithoutMap();
            loadAllData();
            return;
        }

        // ì¹´ì¹´ì˜¤ ê°ì²´ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ (ìµœëŒ€ 10ì´ˆ ëŒ€ê¸°)
        let retryCount = 0;
        const maxRetries = 50; // 10ì´ˆ (200ms * 50)

        function checkKakaoSDK() {
            retryCount++;

            if (typeof kakao === 'undefined') {
                if (retryCount < maxRetries) {
                    console.log(`ì¹´ì¹´ì˜¤ SDK ë¡œë”© ì¤‘... (${retryCount}/${maxRetries})`);
                    setTimeout(checkKakaoSDK, 200);
                    return;
                } else {
                    console.error('ì¹´ì¹´ì˜¤ SDK ë¡œë“œ ì‹¤íŒ¨ - íƒ€ì„ì•„ì›ƒ');
                    initializeWithoutMap();
                    loadAllData();
                    return;
                }
            }

            // ì¹´ì¹´ì˜¤ ì§€ë„ API ë¡œë“œ
            if (typeof kakao.maps === 'undefined') {
                console.log('ì¹´ì¹´ì˜¤ ì§€ë„ API ë¡œë”© ì¤‘...');
                try {
                    kakao.maps.load(function() {
                        console.log('ì¹´ì¹´ì˜¤ ì§€ë„ API ë¡œë“œ ì™„ë£Œ');
                        initializeMap();
                        loadAllData();
                    });
                } catch (error) {
                    console.error('ì¹´ì¹´ì˜¤ ì§€ë„ API ë¡œë“œ ì‹¤íŒ¨:', error);
                    initializeWithoutMap();
                    loadAllData();
                }
            } else {
                console.log('ì¹´ì¹´ì˜¤ ì§€ë„ API ì´ë¯¸ ë¡œë“œë¨');
                initializeMap();
                loadAllData();
            }
        }

        checkKakaoSDK();
    }

    // ì§€ë„ ì—†ì´ ì´ˆê¸°í™”
    function initializeWithoutMap() {
        console.log('ì§€ë„ ì—†ì´ ì´ˆê¸°í™”');
        const mapContainer = document.getElementById('map');
        mapContainer.innerHTML = `
                <div style="height: 400px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; padding: 2rem;">
                    <div>
                        <h3 style="margin-bottom: 1rem;">ğŸ“ ìœ„ì¹˜ ì…ë ¥ ëª¨ë“œ</h3>
                        <p style="margin-bottom: 0.5rem;">ì§€ë„ê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
                        <p style="margin-bottom: 1rem;">ìœ„ë„ì™€ ê²½ë„ë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 5px; font-size: 0.9rem;">
                            <strong>ì£¼ìš” ë„ì‹œ ì¢Œí‘œ ì°¸ê³ :</strong><br>
                            ì„œìš¸ì‹œì²­: 37.566535, 126.977969<br>
                            ë¶€ì‚°ì‹œì²­: 35.179665, 129.075089<br>
                            ëŒ€êµ¬ì‹œì²­: 35.871435, 128.601445<br>
                            ì¸ì²œì‹œì²­: 37.456256, 126.705206
                        </div>
                    </div>
                </div>
            `;

        // ì§€ë„ ê´€ë ¨ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
        const mapButton = document.getElementById('map-select-btn');
        if (mapButton) {
            mapButton.textContent = 'ğŸ“ ì¢Œí‘œ ì…ë ¥ ê°€ì´ë“œ';
            mapButton.className = 'btn btn-secondary';
            mapButton.onclick = function() {
                showCoordinateGuide();
            };
        }
    }

    // ì¢Œí‘œ ìœ íš¨ì„± ê²€ì‚¬
    function validateCoordinate(type, value) {
        const input = document.getElementById(`station-${type}`);
        const numValue = parseFloat(value);

        if (type === 'lat') {
            if (numValue < 33 || numValue > 39) {
                input.style.borderColor = '#dc3545';
                input.style.backgroundColor = '#f8d7da';
            } else {
                input.style.borderColor = '#28a745';
                input.style.backgroundColor = '#d4edda';
            }
        } else if (type === 'lng') {
            if (numValue < 124 || numValue > 132) {
                input.style.borderColor = '#dc3545';
                input.style.backgroundColor = '#f8d7da';
            } else {
                input.style.borderColor = '#28a745';
                input.style.backgroundColor = '#d4edda';
            }
        }
    }

    // ì£¼ìš” ë„ì‹œ í”„ë¦¬ì…‹ ì„ íƒ
    function usePresetLocation() {
        const presets = {
            'ì„œìš¸ì‹œì²­': { lat: 37.566535, lng: 126.977969 },
            'ë¶€ì‚°ì‹œì²­': { lat: 35.179665, lng: 129.075089 },
            'ëŒ€êµ¬ì‹œì²­': { lat: 35.871435, lng: 128.601445 },
            'ì¸ì²œì‹œì²­': { lat: 37.456256, lng: 126.705206 },
            'ê´‘ì£¼ì‹œì²­': { lat: 35.160032, lng: 126.851338 },
            'ëŒ€ì „ì‹œì²­': { lat: 36.350469, lng: 127.384846 },
            'ìš¸ì‚°ì‹œì²­': { lat: 35.539396, lng: 129.311378 },
            'ì„¸ì¢…ì‹œì²­': { lat: 36.480041, lng: 127.289403 }
        };

        let options = 'ì£¼ìš” ë„ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”:\n\n';
        const cities = Object.keys(presets);
        cities.forEach((city, index) => {
            options += `${index + 1}. ${city}\n`;
        });

        const choice = prompt(options + '\nìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš” (1-8):');
        const cityIndex = parseInt(choice) - 1;

        if (cityIndex >= 0 && cityIndex < cities.length) {
            const selectedCity = cities[cityIndex];
            const coords = presets[selectedCity];

            document.getElementById('station-lat').value = coords.lat;
            document.getElementById('station-lng').value = coords.lng;

            // ìœ íš¨ì„± ê²€ì‚¬ ì‹¤í–‰
            validateCoordinate('lat', coords.lat);
            validateCoordinate('lng', coords.lng);

            showMessage('stations-message', `${selectedCity} ì¢Œí‘œê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }
    }

    // ì´ˆê¸°í™” - DOM ë¡œë“œì™€ ìœˆë„ìš° ë¡œë“œ ëª¨ë‘ ì²˜ë¦¬
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }

    // í† í° ê°€ì ¸ì˜¤ê¸°
    function getAuthToken() {
        return document.getElementById('auth-token').value;
    }

    // API í˜¸ì¶œ í—¬í¼
    async function apiCall(url, options = {}) {
        const token = getAuthToken();
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers
        };

        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        const response = await fetch(url, {
            ...options,
            headers
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        return await response.json();
    }

    // íƒ­ ì „í™˜
    function showTab(tabName) {
        // ëª¨ë“  íƒ­ ë²„íŠ¼ê³¼ íŒ¨ë„ ë¹„í™œì„±í™”
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));

        // ì„ íƒëœ íƒ­ í™œì„±í™”
        event.target.classList.add('active');
        document.getElementById(tabName).classList.add('active');

        // íƒ­ë³„ ë°ì´í„° ë¡œë“œ
        if (tabName === 'routes') {
            loadAvailableStations();
            loadRoutes();
        } else if (tabName === 'buses') {
            loadRoutesForBus();
            loadBuses();
        } else if (tabName === 'overview') {
            loadOverview();
        }
    }

    // ì§€ë„ ì´ˆê¸°í™”
    function initializeMap() {
        try {
            if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
                console.error('ì¹´ì¹´ì˜¤ ì§€ë„ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                document.getElementById('map').innerHTML = '<div style="padding: 2rem; text-align: center; color: #dc3545;">ì¹´ì¹´ì˜¤ ì§€ë„ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>';
                return;
            }

            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(37.566826, 126.9786567),
                level: 3
            };

            map = new kakao.maps.Map(mapContainer, mapOption);

            // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸
            kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
                const latlng = mouseEvent.latLng;

                // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
                if (currentMarker) {
                    currentMarker.setMap(null);
                }

                // ìƒˆ ë§ˆì»¤ ìƒì„±
                currentMarker = new kakao.maps.Marker({
                    position: latlng
                });
                currentMarker.setMap(map);

                // ì¢Œí‘œ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
                document.getElementById('station-lat').value = latlng.getLat();
                document.getElementById('station-lng').value = latlng.getLng();
            });

            console.log('ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ');
        } catch (error) {
            console.error('ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            document.getElementById('map').innerHTML = '<div style="padding: 2rem; text-align: center; color: #dc3545;">ì§€ë„ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.</div>';
        }
    }

    // ëª¨ë“  ë°ì´í„° ë¡œë“œ
    async function loadAllData() {
        try {
            await loadStations();
        } catch (error) {
            console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // ì •ë¥˜ì¥ ëª©ë¡ ë¡œë“œ
    async function loadStations() {
        try {
            const response = await apiCall('/api/station');
            stationsData = response.data || [];
            renderStations();
        } catch (error) {
            console.error('ì •ë¥˜ì¥ ë¡œë“œ ì‹¤íŒ¨:', error);
            document.getElementById('stations-list').innerHTML = '<p>ì •ë¥˜ì¥ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    // ì •ë¥˜ì¥ ëª©ë¡ ë Œë”ë§
    function renderStations() {
        const container = document.getElementById('stations-list');
        if (stationsData.length === 0) {
            container.innerHTML = '<p>ë“±ë¡ëœ ì •ë¥˜ì¥ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì •ë¥˜ì¥ì„ ìƒì„±í•´ì£¼ì„¸ìš”.</p>';
            return;
        }

        container.innerHTML = stationsData.map(station => `
                <div class="list-item">
                    <div class="list-item-header">
                        <span class="list-item-title">${station.name}</span>
                        <div class="list-item-actions">
                            <button class="btn btn-danger" onclick="deleteStation('${station.id}')">ì‚­ì œ</button>
                        </div>
                    </div>
                    <p>ìœ„ì¹˜: ${station.location ? `${station.location.y.toFixed(6)}, ${station.location.x.toFixed(6)}` : 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ'}</p>
                </div>
            `).join('');
    }

    // ì •ë¥˜ì¥ ìƒì„±
    async function createStation() {
        const name = document.getElementById('station-name').value.trim();
        const lat = parseFloat(document.getElementById('station-lat').value);
        const lng = parseFloat(document.getElementById('station-lng').value);

        if (!name) {
            showMessage('stations-message', 'ì •ë¥˜ì¥ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        if (!lat || !lng) {
            showMessage('stations-message', 'ìœ„ë„ì™€ ê²½ë„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        // í•œêµ­ ì§€ì—­ ì¢Œí‘œ ìœ íš¨ì„± ê²€ì‚¬
        if (lat < 33 || lat > 39) {
            showMessage('stations-message', 'ìœ„ë„ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í•œêµ­ ì§€ì—­ì€ 33~39 ì‚¬ì´ì…ë‹ˆë‹¤.', 'error');
            return;
        }

        if (lng < 124 || lng > 132) {
            showMessage('stations-message', 'ê²½ë„ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í•œêµ­ ì§€ì—­ì€ 124~132 ì‚¬ì´ì…ë‹ˆë‹¤.', 'error');
            return;
        }

        try {
            await apiCall('/api/station', {
                method: 'POST',
                body: JSON.stringify({
                    name: name,
                    latitude: lat,
                    longitude: lng
                })
            });

            showMessage('stations-message', 'ì •ë¥˜ì¥ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

            // í¼ ë¦¬ì…‹
            document.getElementById('station-name').value = '';
            document.getElementById('station-lat').value = '';
            document.getElementById('station-lng').value = '';

            // ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ ë¦¬ì…‹
            ['station-lat', 'station-lng'].forEach(id => {
                const input = document.getElementById(id);
                input.style.borderColor = '#ced4da';
                input.style.backgroundColor = 'white';
            });

            // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            await loadStations();
        } catch (error) {
            console.error('ì •ë¥˜ì¥ ìƒì„± ì‹¤íŒ¨:', error);
            showMessage('stations-message', 'ì •ë¥˜ì¥ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì •ë¥˜ì¥ ì‚­ì œ
    async function deleteStation(stationId) {
        if (!confirm('ì´ ì •ë¥˜ì¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        try {
            await apiCall(`/api/station/${stationId}`, {
                method: 'DELETE'
            });

            showMessage('stations-message', 'ì •ë¥˜ì¥ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            await loadStations();
        } catch (error) {
            console.error('ì •ë¥˜ì¥ ì‚­ì œ ì‹¤íŒ¨:', error);
            showMessage('stations-message', 'ì •ë¥˜ì¥ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë©”ì‹œì§€ í‘œì‹œ
    function showMessage(elementId, message, type) {
        const messageEl = document.getElementById(elementId);
        messageEl.textContent = message;
        messageEl.className = `message ${type}`;
        messageEl.style.display = 'block';

        setTimeout(() => {
            messageEl.style.display = 'none';
        }, 5000);
    }

    // ë…¸ì„  ê´€ë ¨ í•¨ìˆ˜ë“¤
    function showStationSelector() {
        document.getElementById('station-selector').style.display = 'block';
        loadAvailableStations();
    }

    function loadAvailableStations() {
        const select = document.getElementById('available-stations');
        select.innerHTML = stationsData.map(station =>
            `<option value="${station.id}">${station.name}</option>`
        ).join('');
    }

    function addStationToRoute() {
        const select = document.getElementById('available-stations');
        const selectedOption = select.options[select.selectedIndex];

        if (!selectedOption) return;

        const station = {
            id: selectedOption.value,
            name: selectedOption.text
        };

        if (!selectedStations.find(s => s.id === station.id)) {
            selectedStations.push(station);
            renderSelectedStations();
        }
    }

    function removeStationFromRoute() {
        const container = document.getElementById('selected-stations');
        const selectedItem = container.querySelector('.station-item.selected');

        if (selectedItem) {
            const stationId = selectedItem.dataset.stationId;
            selectedStations = selectedStations.filter(s => s.id !== stationId);
            renderSelectedStations();
        }
    }

    function renderSelectedStations() {
        const container = document.getElementById('selected-stations');
        container.innerHTML = selectedStations.map((station, index) => `
                <div class="station-item" data-station-id="${station.id}" onclick="selectStationItem(this)">
                    <div style="display: flex; align-items: center;">
                        <span class="station-number">${index + 1}</span>
                        <span>${station.name}</span>
                    </div>
                    <button class="btn btn-danger" onclick="removeStationById('${station.id}')" style="padding: 0.25rem 0.5rem;">Ã—</button>
                </div>
            `).join('');
    }

    function selectStationItem(element) {
        document.querySelectorAll('.station-item').forEach(item => item.classList.remove('selected'));
        element.classList.add('selected');
    }

    function removeStationById(stationId) {
        selectedStations = selectedStations.filter(s => s.id !== stationId);
        renderSelectedStations();
    }

    // ë…¸ì„  ìƒì„±
    async function createRoute() {
        const routeName = document.getElementById('route-name').value.trim();

        if (!routeName) {
            showMessage('routes-message', 'ë…¸ì„  ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        if (selectedStations.length < 2) {
            showMessage('routes-message', 'ìµœì†Œ 2ê°œ ì´ìƒì˜ ì •ë¥˜ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        try {
            const stations = selectedStations.map((station, index) => ({
                sequence: index + 1,
                stationId: station.id
            }));

            await apiCall('/api/routes', {
                method: 'POST',
                body: JSON.stringify({
                    routeName: routeName,
                    stations: stations
                })
            });

            showMessage('routes-message', 'ë…¸ì„ ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

            // í¼ ë¦¬ì…‹
            document.getElementById('route-name').value = '';
            selectedStations = [];
            renderSelectedStations();
            document.getElementById('station-selector').style.display = 'none';

            // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            await loadRoutes();
        } catch (error) {
            console.error('ë…¸ì„  ìƒì„± ì‹¤íŒ¨:', error);
            showMessage('routes-message', 'ë…¸ì„  ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë…¸ì„  ëª©ë¡ ë¡œë“œ
    async function loadRoutes() {
        try {
            const response = await apiCall('/api/routes');
            routesData = response.data || [];
            renderRoutes();
        } catch (error) {
            console.error('ë…¸ì„  ë¡œë“œ ì‹¤íŒ¨:', error);
            document.getElementById('routes-list').innerHTML = '<p>ë…¸ì„  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    // ë…¸ì„  ëª©ë¡ ë Œë”ë§
    function renderRoutes() {
        const container = document.getElementById('routes-list');
        if (routesData.length === 0) {
            container.innerHTML = '<p>ë“±ë¡ëœ ë…¸ì„ ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì •ë¥˜ì¥ì„ ìƒì„±í•œ í›„ ë…¸ì„ ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.</p>';
            return;
        }

        container.innerHTML = routesData.map(route => `
                <div class="list-item">
                    <div class="list-item-header">
                        <span class="list-item-title">${route.routeName}</span>
                        <div class="list-item-actions">
                            <button class="btn btn-danger" onclick="deleteRoute('${route.id}')">ì‚­ì œ</button>
                        </div>
                    </div>
                    <p>ì •ë¥˜ì¥ ìˆ˜: ${route.stations ? route.stations.length : 0}ê°œ</p>
                    <p>ì •ë¥˜ì¥: ${route.stations ? route.stations.map(s => s.stationName).join(' â†’ ') : 'ì—†ìŒ'}</p>
                </div>
            `).join('');
    }

    // ë…¸ì„  ì‚­ì œ
    async function deleteRoute(routeId) {
        if (!confirm('ì´ ë…¸ì„ ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        try {
            await apiCall(`/api/routes/${routeId}`, {
                method: 'DELETE'
            });

            showMessage('routes-message', 'ë…¸ì„ ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            await loadRoutes();
        } catch (error) {
            console.error('ë…¸ì„  ì‚­ì œ ì‹¤íŒ¨:', error);
            showMessage('routes-message', 'ë…¸ì„  ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë²„ìŠ¤ìš© ë…¸ì„  ëª©ë¡ ë¡œë“œ
    function loadRoutesForBus() {
        const select = document.getElementById('bus-route');
        select.innerHTML = '<option value="">ë…¸ì„ ì„ ì„ íƒí•˜ì„¸ìš”</option>' +
            routesData.map(route =>
                `<option value="${route.id}">${route.routeName}</option>`
            ).join('');
    }

    // ë²„ìŠ¤ ìƒì„±
    async function createBus() {
        const busRealNumber = document.getElementById('bus-real-number').value.trim();
        const routeId = document.getElementById('bus-route').value;
        const totalSeats = parseInt(document.getElementById('bus-total-seats').value);

        if (!busRealNumber) {
            showMessage('buses-message', 'ë²„ìŠ¤ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        if (!routeId) {
            showMessage('buses-message', 'ë…¸ì„ ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        if (!totalSeats || totalSeats < 1) {
            showMessage('buses-message', 'ì˜¬ë°”ë¥¸ ì¢Œì„ ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        try {
            await apiCall('/api/bus', {
                method: 'POST',
                body: JSON.stringify({
                    routeId: routeId,
                    totalSeats: totalSeats,
                    busRealNumber: busRealNumber,
                    isOperate: true
                })
            });

            showMessage('buses-message', 'ë²„ìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

            // í¼ ë¦¬ì…‹
            document.getElementById('bus-real-number').value = '';
            document.getElementById('bus-route').value = '';
            document.getElementById('bus-total-seats').value = '30';

            // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            await loadBuses();
        } catch (error) {
            console.error('ë²„ìŠ¤ ìƒì„± ì‹¤íŒ¨:', error);
            showMessage('buses-message', 'ë²„ìŠ¤ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë²„ìŠ¤ ëª©ë¡ ë¡œë“œ
    async function loadBuses() {
        try {
            const response = await apiCall('/api/bus');
            busesData = response.data || [];
            renderBuses();
        } catch (error) {
            console.error('ë²„ìŠ¤ ë¡œë“œ ì‹¤íŒ¨:', error);
            document.getElementById('buses-list').innerHTML = '<p>ë²„ìŠ¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    // ë²„ìŠ¤ ëª©ë¡ ë Œë”ë§
    function renderBuses() {
        const container = document.getElementById('buses-list');
        if (busesData.length === 0) {
            container.innerHTML = '<p>ë“±ë¡ëœ ë²„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë…¸ì„ ì„ ìƒì„±í•œ í›„ ë²„ìŠ¤ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.</p>';
            return;
        }

        container.innerHTML = busesData.map(bus => `
                <div class="list-item">
                    <div class="list-item-header">
                        <span class="list-item-title">ë²„ìŠ¤ ${bus.busRealNumber} (${bus.busNumber})</span>
                        <div class="list-item-actions">
                            <button class="btn ${bus.isOperate ? 'btn-secondary' : 'btn-success'}"
                                    onclick="toggleBusOperation('${bus.busNumber}', ${!bus.isOperate})">
                                ${bus.isOperate ? 'ìš´í–‰ ì¤‘ì§€' : 'ìš´í–‰ ì‹œì‘'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteBus('${bus.busNumber}')">ì‚­ì œ</button>
                        </div>
                    </div>
                    <p>ë…¸ì„ : ${bus.routeName}</p>
                    <p>ì¢Œì„: ${bus.occupiedSeats}/${bus.totalSeats} (ì‚¬ìš©ê°€ëŠ¥: ${bus.availableSeats})</p>
                    <p>ìƒíƒœ: ${bus.isOperate ? 'ìš´í–‰ì¤‘' : 'ìš´í–‰ì¤‘ì§€'}</p>
                    <p>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${bus.lastUpdateTime ? new Date(bus.lastUpdateTime).toLocaleString() : 'ì—†ìŒ'}</p>
                </div>
            `).join('');
    }

    // ë²„ìŠ¤ ìš´í–‰ ìƒíƒœ í† ê¸€
    async function toggleBusOperation(busNumber, isOperate) {
        try {
            await apiCall(`/api/bus/${busNumber}/operate?isOperate=${isOperate}`, {
                method: 'PUT'
            });

            showMessage('buses-message', `ë²„ìŠ¤ ìš´í–‰ ìƒíƒœê°€ ${isOperate ? 'ì‹œì‘' : 'ì¤‘ì§€'}ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            await loadBuses();
        } catch (error) {
            console.error('ë²„ìŠ¤ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
            showMessage('buses-message', 'ë²„ìŠ¤ ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë²„ìŠ¤ ì‚­ì œ
    async function deleteBus(busNumber) {
        if (!confirm('ì´ ë²„ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        try {
            await apiCall(`/api/bus/${busNumber}`, {
                method: 'DELETE'
            });

            showMessage('buses-message', 'ë²„ìŠ¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            await loadBuses();
        } catch (error) {
            console.error('ë²„ìŠ¤ ì‚­ì œ ì‹¤íŒ¨:', error);
            showMessage('buses-message', 'ë²„ìŠ¤ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë²„ìŠ¤ ì‚­ì œ
    async function deleteBus(busNumber) {
        if (!confirm('ì´ ë²„ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        try {
            await apiCall(`/api/bus/${busNumber}`, {
                method: 'DELETE'
            });

            showMessage('buses-message', 'ë²„ìŠ¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            await loadBuses();
        } catch (error) {
            console.error('ë²„ìŠ¤ ì‚­ì œ ì‹¤íŒ¨:', error);
            showMessage('buses-message', 'ë²„ìŠ¤ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // í˜„í™© ë¡œë“œ
    async function loadOverview() {
        try {
            // ì •ë¥˜ì¥ í˜„í™©
            document.getElementById('overview-stations').innerHTML = `
                    <p><strong>ì´ ì •ë¥˜ì¥ ìˆ˜:</strong> ${stationsData.length}ê°œ</p>
                    ${stationsData.length > 0 ? `
                        <p><strong>ìµœê·¼ ìƒì„±:</strong> ${stationsData[stationsData.length - 1].name}</p>
                    ` : '<p>ë“±ë¡ëœ ì •ë¥˜ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
                `;

            // ë…¸ì„  í˜„í™©
            document.getElementById('overview-routes').innerHTML = `
                    <p><strong>ì´ ë…¸ì„  ìˆ˜:</strong> ${routesData.length}ê°œ</p>
                    ${routesData.length > 0 ? `
                        <p><strong>í‰ê·  ì •ë¥˜ì¥ ìˆ˜:</strong> ${Math.round(routesData.reduce((sum, route) => sum + (route.stations ? route.stations.length : 0), 0) / routesData.length)}ê°œ</p>
                    ` : '<p>ë“±ë¡ëœ ë…¸ì„ ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
                `;

            // ë²„ìŠ¤ í˜„í™©
            const operatingBuses = busesData.filter(bus => bus.isOperate).length;
            const totalSeats = busesData.reduce((sum, bus) => sum + bus.totalSeats, 0);
            const occupiedSeats = busesData.reduce((sum, bus) => sum + bus.occupiedSeats, 0);

            document.getElementById('overview-buses').innerHTML = `
                    <p><strong>ì´ ë²„ìŠ¤ ìˆ˜:</strong> ${busesData.length}ëŒ€</p>
                    <p><strong>ìš´í–‰ ì¤‘ì¸ ë²„ìŠ¤:</strong> ${operatingBuses}ëŒ€</p>
                    <p><strong>ì „ì²´ ì¢Œì„:</strong> ${totalSeats}ì„</p>
                    <p><strong>ì‚¬ìš© ì¤‘ ì¢Œì„:</strong> ${occupiedSeats}ì„ (${totalSeats > 0 ? Math.round((occupiedSeats / totalSeats) * 100) : 0}%)</p>
                `;
        } catch (error) {
            console.error('í˜„í™© ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // ì§€ë„ì—ì„œ ì •ë¥˜ì¥ ìœ„ì¹˜ ì„ íƒ
    function addStationFromMap() {
        if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined' || !map) {
            alert('ì§€ë„ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìœ„ë„ì™€ ê²½ë„ë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.\n\nì˜ˆì‹œ:\n- ì„œìš¸ì‹œì²­: ìœ„ë„ 37.566535, ê²½ë„ 126.977969\n- ë¶€ì‚°ì‹œì²­: ìœ„ë„ 35.179665, ê²½ë„ 129.075089');
            document.getElementById('station-lat').focus();
            return;
        }
        alert('ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì •ë¥˜ì¥ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
    }

    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
        if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            window.location.href = '/staff/login';
        }
    }

    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ (í˜ì´ì§€ ë¡œë“œ ì‹œ)
    async function initializeData() {
        await loadStations();
        await loadRoutes();
        await loadBuses();
    }

    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™”
    window.addEventListener('load', function() {
        initializeData();
    });
</script>
</body>
</html>